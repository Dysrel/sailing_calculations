/*! homegrown-sailing 2014-10-04 */
!function(){"use strict";var a="3440.06479",b=function(a){return(180*a/Math.PI+360)%360},c=function(a){return a*Math.PI/180},d={tws:function(a,b,d){return Math.sqrt(a*a+d*d-2*d*a*Math.cos(c(Math.abs(b))))},twa:function(a,d,e){var f=b(Math.asin(a*Math.sin(c(Math.abs(d)))/e))+Math.abs(d);return 0>d&&(f*=-1),f},vmg:function(a,b){return Math.abs(a*Math.cos(c(b)))},twd:function(a,b){return(a+b+360)%360},distance:function(b,d,e,f){b=c(b),e=c(e),d=c(d),f=c(f);var g=e-b,h=f-d,i=Math.sin(g/2)*Math.sin(g/2)+Math.cos(b)*Math.cos(e)*Math.sin(h/2)*Math.sin(h/2),j=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i));return a*j},bearing:function(a,d,e,f){a=c(a),e=c(e),d=c(d),f=c(f);var g=f-d,h=Math.sin(g)*Math.cos(e),i=Math.cos(a)*Math.sin(e)-Math.sin(a)*Math.cos(e)*Math.cos(g);return b(Math.atan2(h,i))},steer:function(a,b){var c=b-a;return c>180?c=360-c:-180>c&&(c=360+c),c},crossTrackError:function(b,d,e,f,g,h){var i=distance(b,d,g,h),j=bearing(b,d,g,h),k=bearing(b,d,e,f);return Math.asin(Math.sin(i/a)*Math.sin(c(k-j)))*a},set:function(){},drift:function(){}};"undefined"!=typeof exports?exports.Calcs=d:"undefined"!=typeof module&&module.exports?module.exports=d:("undefined"==typeof homegrown&&(window.homegrown={}),homegrown.calculations=d)}(),function(){"use strict";function a(a){for(var b=[],c=null,d=a[0].t,e=0;e<a.length;e++)if("twa"in a[e]){var f="U-S";-90<=a[e].twa&&a[e].twa<0?f="U-P":a[e].twa<-90?f="D-P":a[e].twa>90&&(f="D-S"),a[e].ot<300&&(f="PS"),c!=f&&(null!==c&&b.push({board:c,start:d,end:a[e].t}),c=f,d=a[e].t)}return b}function b(a,b){for(var e=[],f=2;f<a.length;f++)if("U"==a[f].board.charAt(0)&&"U"==a[f-1].board.charAt(0)){var g=moment(a[f].start);if("PS"==a[f-1].board)return;var h=moment(a[f].start).subtract("seconds",20),i=c.sortedIndex(b,{t:h},function(a){return a.t}),j=moment(a[f].start).add("seconds",120),k=c.sortedIndex(b,{t:j},function(a){return a.t}),l=b.slice(i,k+1),m={time:g,board:a[f].board,timing:{}};d.findCenter(m,l),d.findStart(m,l),d.calculateEntrySpeeds(m,l),d.findEnd(m,l),d.findRecoveryTime(m,l),d.findRecoveryMetrics(m,l),d.convertIndexesToTimes(m,l),d.calculateLoss(m,l),e.push(m)}return e}var c;"undefined"!=typeof window?c=window._:"function"==typeof require&&(c=require("lodash"));var d={findCenter:function(a,b){for(var c,d=0;d<b.length;d++)if(a.time.isSame(b[d].t)){c=d-1;break}a.timing.center=c,a.position=[b[c].lon,b[c].lat]},findStart:function(a,b){for(var c,d=a.timing.center-3;d>=0;d--)if("rot"in b[d]&&Math.abs(b[d].rot)<2.5){c=d;break}a.timing.start=c||15,a.startPosition=[b[a.timing.start].lon,b[a.timing.start].lat]},calculateEntrySpeeds:function(a,b){for(var c=Math.max(0,a.timing.start-6),d=Math.min(b.length-2,a.timing.start-2),e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=c+1;d>=m;m++)"vmg"in b[m]&&(f+=b[m].vmg,h++),"speed"in b[m]&&(e+=b[m].speed,g++),"twa"in b[m]&&(i+=b[m].twa,j++),"hdg"in b[m]&&(k+=b[m].hdg+360,l++);a.entryVmg=f/h,a.entrySpeed=e/g,a.entryTwa=i/j,a.entryHdg=k/l%360},findEnd:function(a,b){var c=a.timing.center,d=("U-P"==a.board)>0?!0:!1;d=!d;for(var e=a.timing.center;e<a.timing.center+12;e++)"twa"in b[e]&&("twa"in b[c]||(c=e),d?b[e].twa>b[c].twa&&(c=e):b[e].twa<b[c].twa&&(c=e));a.timing.end=c,a.maxTwa=b[a.timing.end].twa,a.endPosition=[b[a.timing.end].lon,b[a.timing.end].lat]},findRecoveryTime:function(a,b){for(var c=a.timing.end+5;c<b.length;c++)if("vmg"in b[c]&&a.entryVmg<=b[c].vmg){a.timing.recovered=c;break}a.timing.recovered=a.timing.recovered||a.timing.center+30},findRecoveryMetrics:function(a,b){for(var c=0,d=0,e=0,f=0,g=Math.min(a.timing.recovered+6,b.length),h=a.timing.recovered;g>h;h++)"twa"in b[h]&&(c+=b[h].twa,d++),"hdg"in b[h]&&(e+=b[h].hdg+360,f++);a.recoveryTwa=c/d,a.recoveryHdg=e/f%360},convertIndexesToTimes:function(a,b){a.timing=c.mapValues(a.timing,function(a){return moment(b[a].t)})},calculateLoss:function(a,b){var d=0,e=0,f=a.timing.recovered;c(b).filter(function(b){return b.t>=a.timing.start&&b.t<=f}).each(function(a){"vmg"in a&&(d&&(e+=(a.t-d)/1e3*a.vmg),d=a.t)});var g=a.entryVmg*((f-a.timing.start)/1e3);a.loss=-6076.11549/3600*(g-e)}},e={findManeuvers:a,analyzeTacks:b};"undefined"!=typeof exports?exports.Maneuvers=e:"undefined"!=typeof module&&module.exports?module.exports.Maneuvers=e:("undefined"==typeof homegrown&&(window.homegrown={}),homegrown.maneuvers=e)}(),function(){"use strict";function a(a){var b=a.toString().replace(c,""),e=b.slice(b.indexOf("(")+1,b.indexOf(")")).match(d);return null===e&&(e=[]),e}var b;"undefined"!=typeof window?b=window._:"function"==typeof require&&(b=require("lodash"));var c=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,d=/([^\s,]+)/g,e={derivitive:function(a,b,c){c=c||1;var d,e=null;return function(f){var g=null;if(b in f){if(null!==e){var h=(f[b]-e)/((f.t-d)/1e3)*c;g={},g[a]=h}e=f[b],d=f.t}return g}},delayedInputs:function(c){var d=a(c),e=[];return function(a){for(var f=b.map(d,function(b){return a[b]}),g=!0,h=0;h<d.length;h++)f[h]&&(e[h]=f[h]),e[h]||(g=!1);if(g){var i=c.apply(this,e);e=[];var j={};return j[c.name]=i,j}return null}}};"undefined"!=typeof exports?exports.Utilities=e:"undefined"!=typeof module&&module.exports?module.exports.Utilities=e:("undefined"==typeof homegrown&&(window.homegrown={}),homegrown.streamingUtilities=e)}();