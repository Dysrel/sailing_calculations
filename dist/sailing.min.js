/*! homegrown-sailing 2015-11-05 */
!function(){"use strict";function a(a){var b=a.toString().replace(c,""),e=b.slice(b.indexOf("(")+1,b.indexOf(")")).match(d);return null===e&&(e=[]),e}var b;"undefined"!=typeof window?b=window._:"function"==typeof require&&(b=require("lodash"));var c=/((\/\/.*$)|(\/\*[\s\S]*?\*\/))/gm,d=/([^\s,]+)/g,e={derivitive:function(a,b,c){c=c||1;var d,e=null;return function(f){var g=null;if(b in f){if(null!==e){var h=(f[b]-e)/((f.t-d)/1e3)*c;g={},g[a]=h}e=f[b],d=f.t}return g}},average:function(a,b,c){var d=0,e=0,f=[];return function(g){var h=null;if(b in g){var i=e%c;e++,f[i]&&(d-=f[i]),d+=g[b],f[i]=g[b],h={},h[a]=d/f.length}return h}},delayedInputs:function(b){var c=a(b),d=[];return function(a){for(var e=!0,f=0;f<c.length;f++)c[f]in a&&(d[f]=a[c[f]]),d[f]||(e=!1);if(e){var g=b.apply(this,d);d=[];var h={};return h[b.name]=g,h}return null}},segmentData:function(a,c){var d=b.clone(c,!0);b.each(d,function(a){a.data=[]});for(var e=0,f=0;f<a.length;f++)if(!(a[f].t<d[e].start))if(a[f].t<d[e].end)d[e].data.push(a[f]);else{if(e++,e>=d.length)break;d[e].data.push(a[f])}return d},createChangeDataSegments:function(a,b){var c,d,e=[],f=null,g=null;"function"==typeof b?(c=b,d=b.name):(c=function(a){return b in a?a[b]:null},d=b);for(var h=0;h<a.length;h++){var i=c(a[h]);if(i){f=i,g=a[h].t;break}}for(;h<a.length;h++){var j=c(a[h]);if(j&&j!=f){var k={start:g,end:a[h].t};k[d]=f,e.push(k),f=j,g=a[h].t}}return e},createSummaryDataSegments:function(a,b,c){c=c||1e4;for(var d=[],e=0,f=0,g=a[0].t,h=0;h<a.length;h++){if(a[h].t>g+c){var i={start:g,end:a[h].t};i[b]=e/f,d.push(i),e=0,f=0,g=a[h].t}b in a[h]&&(e+=a[h][b],f++)}return d}};"undefined"!=typeof exports?exports.utilities=e:"undefined"!=typeof module&&module.exports?module.exports.utilities=e:("undefined"==typeof homegrown&&(window.homegrown={}),homegrown.streamingUtilities=e)}(),function(){"use strict";var a=3440.06479,b=function(a){return(180*a/Math.PI+360)%360},c=function(a){return a*Math.PI/180},d=function(a,b,d){return Math.sqrt(a*a+b*b-2*b*a*Math.cos(c(Math.abs(d))))},e={tws:function(a,b,c){return d(a,c,b)},twa:function(a,d,e){var f=b(Math.asin(a*Math.sin(c(Math.abs(d)))/e))+Math.abs(d);return 0>d&&(f*=-1),f},gws:function(a,b,c){return d(a,c,b)},gwd:function(a,b,c,d){var f=e.twa(a,c,d);return(b+f+360)%360},vmg:function(a,b){return Math.abs(a*Math.cos(c(b)))},twd:function(a,b){return(a+b+360)%360},distance:function(b,d,e,f){b=c(b),e=c(e),d=c(d),f=c(f);var g=e-b,h=f-d,i=Math.sin(g/2)*Math.sin(g/2)+Math.cos(b)*Math.cos(e)*Math.sin(h/2)*Math.sin(h/2),j=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i));return a*j},bearing:function(a,d,e,f){a=c(a),e=c(e),d=c(d),f=c(f);var g=f-d,h=Math.sin(g)*Math.cos(e),i=Math.cos(a)*Math.sin(e)-Math.sin(a)*Math.cos(e)*Math.cos(g);return b(Math.atan2(h,i))},steer:function(a,b){var c=b-a;return c>180?c=360-c:-180>c&&(c=360+c),c},crossTrackError:function(b,d,e,f,g,h){var i=distance(b,d,g,h),j=bearing(b,d,g,h),k=bearing(b,d,e,f);return Math.asin(Math.sin(i/a)*Math.sin(c(k-j)))*a},set:function(a,d,e,f){d=c(90-d),f=c(90-f);var g=e*Math.cos(f)-a*Math.cos(d),h=e*Math.sin(f)-a*Math.sin(d),i=0;return i=0===g?0>h?180:0:(90-b(Math.atan2(h,g))+360)%360},drift:function(a,b,d,e){b=c(90-b),e=c(90-e);var f=d*Math.cos(e)-a*Math.cos(b),g=d*Math.sin(e)-a*Math.sin(b),h=Math.sqrt(f*f+g*g);return h},circularMean:function(a){var d=0,e=0;return _.each(a,function(a){d+=Math.sin(c(a)),e+=Math.cos(c(a))}),(360+b(Math.atan2(d/a.length,e/a.length)))%360}};"undefined"!=typeof exports?exports.calcs=e:"undefined"!=typeof module&&module.exports?module.exports=e:("undefined"==typeof homegrown&&(window.homegrown={}),homegrown.calculations=e)}(),function(){"use strict";function a(){var a=0,b=0;return{update:function(c){b++,a+=c},result:function(){return b?a/b:void 0}}}function b(a,b,d,e){var f=g(b).subtract(d,"seconds"),h=g(b).add(e,"seconds");return c(a,f,h)}function c(a,b,c){var d=f.sortedIndex(a,{t:b},function(a){return a.t}),e=f.sortedIndex(a,{t:c},function(a){return a.t});return a.slice(d,e+1)}function d(a){function b(a){var b=null;return"twa"in a&&(b="U-S",-90<=a.twa&&a.twa<0?b="U-P":a.twa<-90?b="D-P":a.twa>90&&(b="D-S"),a.ot<300&&(b="PS")),b}return homegrown.streamingUtilities.createChangeDataSegments(a,b)}function e(a,c){for(var d=[],e=2;e<a.length;e++)if("U"==a[e].board.charAt(0)&&"U"==a[e-1].board.charAt(0)){var f=g(a[e].start);if("PS"==a[e-1].board)continue;if(e+1<a.length){var h=g(a[e+1].start).subtract(45,"seconds");if(f>h)continue}var j=b(c,a[e].start,30,120),k={time:f,board:a[e].board,timing:{},notes:[],data:b(c,a[e].start,20,120),track:b(c,a[e].start,15,30)};i.findCenter(k,j),i.findStart(k,j),i.calculateEntrySpeeds(k,j),i.findEnd(k,j),i.findRecoveryTime(k,j),i.findRecoveryMetrics(k,j),i.addClassificationStats(k,j),i.convertIndexesToTimes(k,j),i.calculateLoss(k,j),d.push(k)}return d}var f,g,h;"undefined"!=typeof window?(f=window._,g=window.moment,h=homegrown.calculations.circularMean):"function"==typeof require&&(f=require("lodash"),g=require("moment"));var i={findCenter:function(a,b){for(var c,d=0;d<b.length;d++)if(a.time.isSame(b[d].t)){c=d-1;break}a.timing.center=c,a.position=[b[c].lon,b[c].lat]},findStart:function(a,b){for(var c,d=a.timing.center-3;d>=0;d--)if("rot"in b[d]&&Math.abs(b[d].rot)<2.5){c=d;break}c?a.timing.start=c:(a.timing.start=15,a.notes.push("using default start")),a.startPosition=[b[a.timing.start].lon,b[a.timing.start].lat]},calculateEntrySpeeds:function(b,d){for(var e=g(d[b.timing.start].t).subtract(6,"seconds"),f=g(d[b.timing.start].t).subtract(2,"seconds"),i=c(d,e,f),j=a(),k=a(),l=a(),m=a(),n=a(),o=[],p=0;p<i.length;p++)"vmg"in i[p]&&l.update(i[p].vmg),"speed"in i[p]&&j.update(i[p].speed),"twa"in i[p]&&k.update(i[p].twa),"targetSpeed"in i[p]&&n.update(i[p].targetSpeed),"hdg"in i[p]&&o.push(i[p].hdg),"targetAngle"in i[p]&&m.update(i[p].targetAngle);b.entryVmg=l.result(),b.entrySpeed=j.result(),b.entryTwa=k.result(),b.entryHdg=h(o);var q=n.result();q&&(b.targetSpeed=q,b.entrySpeed<.9*q&&b.notes.push("* started tack downspeed"));var r=m.result();console.info("werid",r),r&&(b.targetAngle=r)},findEnd:function(a,b){var c=a.timing.center,d=("U-P"==a.board)>0?!0:!1;d=!d;for(var e=a.timing.center;e<a.timing.center+12;e++)"twa"in b[e]&&("twa"in b[c]||(c=e),d?b[e].twa>b[c].twa&&(c=e):b[e].twa<b[c].twa&&(c=e));a.timing.end=c,a.maxTwa=b[a.timing.end].twa,a.endPosition=[b[a.timing.end].lon,b[a.timing.end].lat]},findRecoveryTime:function(a,b){for(var c=a.timing.end+5;c<b.length;c++)if("vmg"in b[c]&&a.entryVmg<=b[c].vmg){a.timing.recovered=c;break}a.timing.recovered||(a.timing.recovered=a.timing.center+30,a.notes.push("never found recovery"))},findRecoveryMetrics:function(b,c){for(var d=[],e=a(),f=a(),g=Math.min(b.timing.recovered+6,c.length),i=b.timing.recovered;g>i;i++)"twa"in c[i]&&f.update(c[i].twa),"hdg"in c[i]&&d.push(c[i].hdg),"speed"in c[i]&&e.update(c[i].speed);b.recoveryTwa=f.result(),b.recoveryHdg=h(d),b.recoverySpeed=e.result(),b.targetSpeed&&b.recoverySpeed<.9*b.targetSpeed&&b.notes.push("* never came back up to speed")},convertIndexesToTimes:function(a,b){a.timing=f.mapValues(a.timing,function(a){return g(b[a].t)})},calculateLoss:function(a,b){var c=0,d=0,e=a.timing.recovered;f(b).filter(function(b){return b.t>=a.timing.start&&b.t<=e}).each(function(a){"vmg"in a&&(c&&(d+=(a.t-c)/1e3*a.vmg),c=a.t)});var g=a.entryVmg*((e-a.timing.start)/1e3);a.loss=-6076.11549/3600*(g-d)},addClassificationStats:function(a,b){for(var c=0,d=0,e=[],f=0;f<a.timing.start;f++)"tws"in b[f]&&(c+=b[f].tws,d++),"twd"in b[f]&&e.push(b[f].twd);a.tws=c/d,a.twd=h(e)}},j={findManeuvers:d,analyzeTacks:e,getSliceAroundTime:b,getSliceBetweenTimes:c};"undefined"!=typeof exports?exports.maneuvers=j:"undefined"!=typeof module&&module.exports?module.exports.maneuvers=j:("undefined"==typeof homegrown&&(window.homegrown={}),homegrown.maneuvers=j)}();